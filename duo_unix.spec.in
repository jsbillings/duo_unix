%define develname duo_unix-devel

Name: duo_unix
Version: @VERSION@
Release: 0%{?dist}
Epoch: 0
Summary: Duo two-factor authentication for Unix systems
Packager: S. Zachariah Sprackett <zac@sprackett.com>

Group: System Environment/Base
License: GPLV2
URL: http://www.duosecurity.com/
Source0: https://dl.duosecurity.com/%{name}-%{version}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

Requires: pam, openssl, zlib, openssh-server
BuildRequires: pam-devel, openssl-devel, pkgconfig, zlib-devel
Obsoletes: libduo <= %{version}

%description
Duo provides simple two-factor authentication as a service via:

    1.  Phone callback
    2.  SMS-delivered one-time passcodes
    3.  Duo mobile app to generate one-time passcodes
    4.  Duo mobile app for smartphone push authentication
    5.  Duo hardware token to generate one-time passcodes

This package allows an admin (or ordinary user) to quickly add Duo
authentication to any Unix login without setting up secondary user
accounts, directory synchronization, servers, or hardware.

%package -n pam_duo
Summary: A PAM module for duo authentication
Group: System/Libraries

%description -n pam_duo
A PAM module for duo authentication

%package -n %{develname}
Summary: Development files and documentation for duo_unix
Group: System/Libraries
Requires: %{name} = %{version}

%description -n %{develname}
Development files and documentation for duo_unix

%package selinux
Summary: An SELinux module for duo authentication
Group: System/Libraries
BuildRequires: bzip2, selinux-policy-devel
Requires: %{name} = %{version}
%{!?_selinux_policy_version: %global _selinux_policy_version %(sed -e 's,.*selinux-policy-\\([^/]*\\)/.*,\\1,' /usr/share/selinux/devel/policyhelp 2>/dev/null)}
%if "%{_selinux_policy_version}" != ""
Requires:      selinux-policy >= %{_selinux_policy_version}
%endif
Requires(post):   /usr/sbin/semodule
Requires(postun): /usr/sbin/semodule

%description selinux
An SELinux module for duo authentication

%prep
%setup -q -n %{name}-%{version}

%build
%configure --with-pam=/%{_lib}/security \
           --sysconfdir=%{_sysconfdir}/duo \
           --with-privsep-user=sshd \
           --includedir=/%{_includedir}/duo
make %{?_smp_mflags}
# Build SELinux module
pushd pam_duo
make -f /usr/share/selinux/devel/Makefile

%clean
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT

%check
make check

%install
[ "$RPM_BUILD_ROOT" != "/" ] && rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
rm -f $RPM_BUILD_ROOT/%{_lib}/security/pam_duo.*a

# Remove unnecessary /usr/share/doc/duo_unix directory, documentation
# will be installed in files section
rm -f $RPM_BUILD_ROOT/%{_datarootdir}/doc/duo_unix/*
rmdir $RPM_BUILD_ROOT/%{_datarootdir}/doc/duo_unix

# Install SELinux module
#make -C pam_duo semodule-install DESTDIR=$RPM_BUILD_ROOT
install -d %{buildroot}%{_datadir}/selinux/packages
install -p -m 644 pam_duo/authlogin_duo.pp \
        %{buildroot}%{_datadir}/selinux/packages/authlogin_duo.pp
bzip2 -9 %{buildroot}%{_datadir}/selinux/packages/authlogin_duo.pp

%post selinux
/usr/sbin/semodule -i \
    %{_datadir}/selinux/packages/authlogin_duo.pp.bz2 2> /dev/null || :

%preun selinux
if [ "$1" -lt "1" ] ; then # Final removal
    semodule -r authlogin_duo 2>/dev/null || :
fi

%postun selinux
if [ "$1" -ge "1" ] ; then # Upgrade
    semodule -i \
        %{_datadir}/selinux/packages/authlogin_duo.pp.bz2 2>/dev/null || :
fi


%files
%defattr(-,root,root)
%doc AUTHORS CHANGES LICENSE README
%dir %{_sysconfdir}/duo
%attr(0600, sshd, root) %config(noreplace) %{_sysconfdir}/duo/login_duo.conf
%attr(4755, root, root) %{_sbindir}/login_duo
%{_mandir}/man8/login_duo.8.gz

%files -n pam_duo
%dir %{_sysconfdir}/duo
/%{_lib}/security/pam_duo.so
%config(noreplace) %attr(640, root, root) %{_sysconfdir}/duo/pam_duo.conf
%{_mandir}/man8/pam_duo.8.gz

%files -n %{develname}
%defattr(-,root,root)
%{_includedir}/duo/duo.h
%{_includedir}/duo/util.h
%{_includedir}/duo/shell.h
%{_libdir}/pkgconfig/libduo.pc
%{_mandir}/man3/duo.3.gz

%files selinux
%defattr(-,root,root)
%{_datarootdir}/selinux/packages/authlogin_duo.pp.bz2

%changelog
* Mon Apr 18 2016 Jonathan S. Billings <jsbillin@umich.edu> 0:1.9.18-0
- Clean up Requires and BuildRequires
- openssh-server should be a Required package for 'sshd' user
- Fix docs installation
- Added make check section
- Build SELinux module, put it into its own package

* Sat Jul 12 2014 S. Zachariah Sprackett <zac@sprackett.com> 0:1.9.11-0
- Make things work with modern duo

* Thu Aug 22 2013 Mark Stanislav <mark.stanislav@gmail.com> 0:1.9.3-0
- Fixed documentation path for files breaking RPM build

* Mon Feb 11 2013 S. Zachariah Sprackett <zac@sprackett.com> 0:1.9-0
- Add OpenSSH server buildreq for people building in chroots with Mock
- Fixups to handle documentation being installed by Makefile

* Thu Sep 1 2011 R.I.Pienaar <rip@devco.net> 0:1.8-0
- Fix the ownership of /etc/duo/login_duo.conf so that login as normal users work
* Tue Aug 23 2011 Mark Stanislav <mark.stanislav@gmail.com> 0:1.7-0
- Removed README.{pam,ssh} from build related to commit 0d65488ae3cae2e97484
* Thu May 12 2011 S. Zachariah Sprackett <zac@sprackett.com> 0:1.6-0
- Rolled initial RPM
